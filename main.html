<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Project</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    th {
      background-color: #cce5ff;
      color: #333;
      font-weight: bold;
      padding: 10px;
    }
    td {
      padding: 8px;
    }
    tr:hover td {
      background-color: #e6f7ff;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
    }
    input, button, select, textarea {
      padding: 6px;
      margin: 4px;
    }
    .container {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    a.link {
      text-decoration: none;
      color: #0077cc;
      display: block;
      margin: 2px 0;
    }
    a.link:hover {
      text-decoration: underline;
    }
    .progress-pending  { background-color: white; }
    .progress-working  { background-color: #fffacc; }
    .progress-complete { background-color: #d4fcdc; }
    .progress-maintain { background-color: #ffd6d6; }
  </style>
</head>
<body>
  <div class="container">
    <h2>📁 Danh sách Project của tôi</h2>

    <input type="text" id="name" placeholder="Tên project" />
    <button onclick="generateUniqueRandomName()">🎲 Tên ngẫu nhiên</button><br>
    <input type="text" id="function" placeholder="Chức năng" />
    <input type="datetime-local" id="time" /><br>

    <b>🔗 Thêm Link:</b><br>
    <input type="text" id="linkText" placeholder="Tên link (VD: Google)" />
    <input type="text" id="linkUrl" placeholder="https://google.com" />
    <button onclick="addLink()">➕ Thêm link</button><br>
    <ul id="linkList"></ul>

    <select id="progress">
      <option value="pending">Chưa bắt đầu</option>
      <option value="working">Đang thực hiện</option>
      <option value="complete">Đã hoàn thành</option>
      <option value="maintain">Đang sửa chữa</option>
    </select>
    <button onclick="addProject()">Thêm Project</button>
    <button onclick="exportToExcel()">Xuất Excel</button>
    <input type="file" onchange="importFromExcel(event)" />

    <table id="projectTable">
      <thead>
        <tr>
          <th>STT</th>
          <th>Tên Project</th>
          <th>Chức năng</th>
          <th>Thời gian</th>
          <th>Link(s)</th>
          <th>Tiến độ</th>
          <th>Xóa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let projects = JSON.parse(localStorage.getItem('projects')) || [];
    let currentLinks = [];

    function renderProjects() {
      const tbody = document.querySelector("#projectTable tbody");
      tbody.innerHTML = "";
      projects.forEach((proj, index) => {
        const row = document.createElement("tr");
        const progressClass = {
          pending: 'progress-pending',
          working: 'progress-working',
          complete: 'progress-complete',
          maintain: 'progress-maintain'
        }[proj.progress || 'pending'];
        row.className = progressClass;

        const formattedTime = proj.time ? new Date(proj.time).toLocaleString("vi-VN") : "";

        const linksHtml = (proj.links || []).map((link, i) =>
          `<a href="${link.url}" class="link" target="_blank">🔗 ${link.text || "Link " + (i + 1)}</a>`
        ).join("");

        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${proj.name}</td>
          <td>${proj.function}</td>
          <td>${formattedTime}</td>
          <td>${linksHtml}</td>
          <td>
            <select onchange="updateProgress(${index}, this.value)">
              <option value="pending" ${proj.progress === 'pending' ? 'selected' : ''}>Chưa bắt đầu</option>
              <option value="working" ${proj.progress === 'working' ? 'selected' : ''}>Đang thực hiện</option>
              <option value="complete" ${proj.progress === 'complete' ? 'selected' : ''}>Đã hoàn thành</option>
              <option value="maintain" ${proj.progress === 'maintain' ? 'selected' : ''}>Đang sửa chữa</option>
            </select>
          </td>
          <td><button onclick="deleteProject(${index})">❌</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function addLink() {
      const text = document.getElementById("linkText").value.trim();
      const url = document.getElementById("linkUrl").value.trim();
      if (!url) return alert("Phải nhập URL!");
      currentLinks.push({ text: text || "Link", url });
      renderLinkList();
      document.getElementById("linkText").value = "";
      document.getElementById("linkUrl").value = "";
    }

    function renderLinkList() {
      const ul = document.getElementById("linkList");
      ul.innerHTML = currentLinks.map((link, i) =>
        `<li>${link.text} - <a href="${link.url}" target="_blank">${link.url}</a> 
         <button onclick="removeLink(${i})">❌</button></li>`
      ).join("");
    }

    function removeLink(index) {
      currentLinks.splice(index, 1);
      renderLinkList();
    }

    function addProject() {
      const name = document.getElementById("name").value.trim();
      const func = document.getElementById("function").value.trim();
      const time = document.getElementById("time").value;
      const progress = document.getElementById("progress").value;

      if (!name || !func || !time) return alert("Điền đầy đủ thông tin!");
      if (projects.find(p => p.name === name)) return alert("Tên project đã tồn tại!");

      projects.push({ name, function: func, time, links: [...currentLinks], progress });
      localStorage.setItem("projects", JSON.stringify(projects));
      renderProjects();

      document.getElementById("name").value = "";
      document.getElementById("function").value = "";
      document.getElementById("progress").value = "pending";
      currentLinks = [];
      renderLinkList();
      setDefaultTimeNow();
    }

    function updateProgress(index, newStatus) {
      projects[index].progress = newStatus;
      localStorage.setItem('projects', JSON.stringify(projects));
      renderProjects();
    }

    function deleteProject(index) {
      if (confirm("Xóa project này?")) {
        projects.splice(index, 1);
        localStorage.setItem("projects", JSON.stringify(projects));
        renderProjects();
      }
    }

    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(projects.map((p, i) => ({
        STT: i + 1,
        "Tên Project": p.name,
        "Chức năng": p.function,
        "Thời gian": new Date(p.time).toLocaleString("vi-VN"),
        "Link(s)": (p.links || []).map(l => `${l.text} | ${l.url}`).join('\n'),
        "Tiến độ": {
          pending: "Chưa bắt đầu",
          working: "Đang thực hiện",
          complete: "Đã hoàn thành",
          maintain: "Đang sửa chữa"
        }[p.progress || 'pending']
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Projects");
      XLSX.writeFile(wb, "Danh_sach_project.xlsx");
    }

    function importFromExcel(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const imported = XLSX.utils.sheet_to_json(sheet);

        // ❗ XÓA DỮ LIỆU CŨ
        projects = [];

        const textToProgress = {
          "Chưa bắt đầu": "pending",
          "Đang thực hiện": "working",
          "Đã hoàn thành": "complete",
          "Đang sửa chữa": "maintain"
        };

        imported.forEach(row => {
          const links = (row["Link(s)"] || "").split(/\n+/).map(line => {
            const [text, url] = line.split("|").map(s => s.trim());
            return { text, url };
          }).filter(link => link.url);

          projects.push({
            name: row["Tên Project"],
            function: row["Chức năng"],
            time: new Date(row["Thời gian"]).toISOString(),
            links,
            progress: textToProgress[row["Tiến độ"]] || "pending"
          });
        });

        localStorage.setItem("projects", JSON.stringify(projects));
        renderProjects();
      };
      reader.readAsArrayBuffer(file);
    }

    function generateUniqueRandomName() {
      const digits = "0123456789";
      const letters = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      function shuffle(str) {
        const arr = str.split('');
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr.join('');
      }
      let name, tries = 0;
      do {
        let numPart = "", letterPart = "";
        for (let i = 0; i < 5; i++) {
          numPart += digits[Math.floor(Math.random() * digits.length)];
          letterPart += letters[Math.floor(Math.random() * letters.length)];
        }
        name = shuffle(numPart + letterPart);
        tries++;
        if (tries > 1000) {
          alert("Không thể tạo tên không trùng!"); return;
        }
      } while (projects.find(p => p.name === name));
      document.getElementById("name").value = name;
    }

    function setDefaultTimeNow() {
      const now = new Date();
      const localISO = now.toISOString().slice(0, 16);
      document.getElementById("time").value = localISO;
    }

    renderProjects();
    setDefaultTimeNow();
  </script>
</body>
</html>
